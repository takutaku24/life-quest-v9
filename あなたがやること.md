# こちら側で変更するべきこと

アプリを正しく動かすために、**スプレッドシート** と **設定ファイル** でやっておくことをまとめました。

---

## 1. スプレッドシート（Google スプレッドシート）

### シート名
- **users**（ユーザー情報）
- **tasks**（タスク履歴）
- **inventory**（所持モンスター・アイテム）

この3つが **同じ名前** で存在していること。

---

### users シート：1行目（ヘッダー）の列

**1行目** に、次の列名を **左から順に** 並べてください。  
（既にある列はそのままでOK。足りない列だけ追加。）

| 列 | アルファベット | ヘッダー名（1行目に書く） | 備考 |
|----|----------------|---------------------------|------|
| 1 | A | user_id | 必須。値は `u001` など |
| 2 | B | name | 必須 |
| 3 | C | level | 必須 |
| 4 | D | current_xp | 必須 |
| 5 | E | next_level_xp | 必須 |
| 6 | F | gold | 必須 |
| 7 | G | rebirth_count | 転生を使う場合 |
| 8 | H | dungeon_floor | 必須 |
| 9 | I | login_streak | 推奨 |
| 10 | J | last_login | 推奨（または _login） |
| 11 | K | job_class | 必須 |
| 12 | L | pity_counter | 任意 |
| 13 | M | last_free_gacha | 必須 |
| 14 | N | daily_claimed | **必須（報酬重複防止）** |
| 15 | O | weekly_claimed | **必須（報酬重複防止）** |
| 16 | P | boss_damage | 任意 |
| 17 | Q | equipped_pet | 必須 |
| 18 | R | stamp_card | 任意 |
| 19 | S | weekly_boss_damage | 必須 |
| 20 | T | titles | 任意 |
| 21 | U | title | 転生を使う場合 |
| 22 | V | last_weekly_ticket | **週1チケット用** |
| 23 | W | last_monthly_sr_ticket | **月1 SR確定チケット用** |
| 24 | X | buff_data | バフ用（任意） |
| 25 | Y | achievements | **必須（実績報酬重複防止）** |
| 26 | Z | mission_claimed | **必須（ミッション報酬重複防止）** |
| 27 | AA | boss_claimed | **必須（ボス報酬重複防止）** |
| 28 | AB | streak_protect_date | ストリーク保護用 |
| 29 | AC | last_rest_week | 「今日は休息にする」週1回用 |
| 30 | AD | unlocked_titles | 限定称号（カンマ区切り） |
| 31 | AE | zone_start | ゾーンタイム開始時刻 |
| 32 | AF | zone_log | 集中記録 |
| 33 | AG | task_custom | タスク表示名カスタム（JSON） |
| 34 | AH | seasonal_claimed | 季節ミッション受取月 |
| 35 | AI | outing_start | 相棒おでかけ開始時刻 |

- **列の順番を変えない**（並び替えすると書き込み先がずれます）。
- 列を **足すときは右端（AC の右）に追加** し、上表の列はそのままの位置にしてください。
- ヘッダー名は **スペル・大文字小文字も含めて** 上記のとおりに。

---

### 報酬が何度ももらえてしまう場合

次の列が **1行目に存在しているか** を確認してください。

- **N** → `daily_claimed`
- **O** → `weekly_claimed`
- **Y** → `achievements`
- **Z** → `mission_claimed`
- **AA** → `boss_claimed`
- **V** → `last_weekly_ticket`
- **W** → `last_monthly_sr_ticket`

無い場合は、該当する列の **1行目** に上記の名前を入れてください。

---

### users シート：2行目以降（データ）

- **A列（user_id）** に `u001` の行が **1行以上** あること。
- その行の B〜必要な列まで、名前・レベル・ゴールドなどが入っていればOK（空欄の列はアプリが書き足します）。

---

### tasks シート

- **1行目はヘッダー**：id, user_id, task_name, type, quantity, status, created_at など。
- 2行目以降はタスク完了時にアプリが追加するので、**空でも可**。

---

### inventory シート

- **1行目はヘッダー**：user_id, item_name, rarity, quantity, acquired_at など。
- 2行目以降はガチャでアプリが追加するので、**空でも可**。

---

## 2. スプレッドシートの共有

- アプリ用の **Google サービスアカウント** のメールアドレス（例: `xxx@xxx.iam.gserviceaccount.com`）に、  
  そのスプレッドシートの **編集者** 権限を付与する。
- 共有設定で「リンクを知っている全員」は **編集可** にしなくてよい（サービスアカウントだけ編集者でOK）。

---

## 3. ローカル設定（.streamlit/secrets.toml）

- **GCP のサービスアカウントキー（JSON）** を `gcp_service_account` に設定する。
- **スプレッドシートの URL** を `sheets.url` に設定する。

中身の形式は、プロジェクトの `README.md` や `DEPLOY.md` を参照。

- このファイルは **Git にコミットしない**（.gitignore に含まれているか確認）。

---

## 4. まとめチェックリスト

- [ ] スプレッドシートに **users / tasks / inventory** の3シートがある
- [ ] **users** の1行目に、上表の列名が **順番どおり** 並んでいる（特に N, O, V, W, Y, Z, AA, AB, AC）
- [ ] **users** に `user_id` が `u001` の行が少なくとも1行ある
- [ ] スプレッドシートを **サービスアカウントのメール** に編集者で共有している
- [ ] `.streamlit/secrets.toml` に **gcp_service_account** と **sheets.url** を設定している
- [ ] `secrets.toml` を GitHub などに上げていない

ここまでできていれば、アプリ側で想定している「こちら側で変更するべきところ」は一通り満たせています。
